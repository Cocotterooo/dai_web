---
import SidebarLink from '@/components/admin/adminSidebar/sideBarAdminLink.astro';
import { canViewSidebarSection, hasSectionVisibleItems, SIDEBAR_SECTIONS } from '@/lib/permissions';
// ICONS:
import Archive from '@/assets/icons/archive.svg';
import Almacen from '@/assets/icons/almacen.svg';
import Briefcase from '@/assets/icons/maletin.svg';
import Prints from '@/assets/icons/printer.svg';
import Lock from '@/assets/icons/lock.svg';
import Users from '@/assets/icons/usuarios.svg';
import Tags from '@/assets/icons/tags.svg';
import CalendarConfig from '@/assets/icons/calendars/calendar_config.svg';
import Settings from '@/assets/icons/settings.svg';
import History from '@/assets/icons/history.svg';
import ArrowBack from '@/assets/icons/arrow_back.svg';

export interface Props {
    currentPath: string;
    userRoleIds: string[];
    userRoleNames: string[];
}

const { currentPath, userRoleIds, userRoleNames } = Astro.props;

// Función helper para verificar permisos de elementos individuales
function canViewItem(itemKey: keyof typeof import('@/lib/permissions').PERMISSIONS.SIDEBAR) {
    return canViewSidebarSection(userRoleIds, userRoleNames, itemKey);
}

// Verificar elementos individuales
const canViewDashboard = canViewItem('dashboard');
const canViewPrints = canViewItem('prints');
const canViewLoans = canViewItem('loans'); 
const canViewLockers = canViewItem('lockers');
const canViewInventory = canViewItem('inventory');
const canViewInventoryCoord = canViewItem('inventoryCoord');
const canViewUsers = canViewItem('users');
const canViewRoles = canViewItem('roles');
const canViewEvents = canViewItem('events');
const canViewSettings = canViewItem('settings');
const canViewLogs = canViewItem('logs');

// Verificar si las secciones tienen elementos visibles
const localesSectionVisible = canViewPrints || canViewLoans || canViewLockers;
const gestionSectionVisible = canViewUsers || canViewRoles || canViewEvents;
const sistemaSectionVisible = canViewSettings || canViewLogs;

---

<!-- Overlay para móvil -->
<div 
    id="sidebar-overlay" 
    class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"
    data-sidebar-overlay
></div>

<!-- Sidebar -->
<aside 
    id="admin-sidebar"
    class="fixed left-0 z-50 top-14 h-[calc(100vh-3.5rem)] w-64 bg-azul-oscuro/95 border-r border-white/10 overflow-y-auto backdrop-blur-lg transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out"
    data-sidebar
>
    <div class="p-6">
        <!-- Header del sidebar -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-xl font-bold text-white">DAI Gestión</h2>
                <!-- Botón de cerrar para móvil -->
                <button 
                    type="button"
                    class="lg:hidden text-white/70 hover:text-white p-1 rounded-md hover:bg-white/10 transition-colors"
                    data-sidebar-close
                    aria-label="Cerrar menú"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-white/70 text-sm">Área de gestión de servicios y usuarios de la DAI</p>
        </div>

        <!-- Navegación principal -->
        <nav class="space-y-2">
            <!-- Dashboard -->
            {canViewDashboard && (
                <SidebarLink 
                    href="/admin" 
                    currentPath={currentPath}
                    title="Gestión"
                    icon={Briefcase}
                    exactMatch={true}
                />
            )}

            <!-- Sección Locales -->
            {localesSectionVisible && (
                <>
                    <div class="text-white/50 text-xs font-semibold uppercase tracking-wider mb-3">
                        Locales
                    </div>
                    {canViewPrints && (
                        <SidebarLink 
                            href="/admin/prints" 
                            currentPath={currentPath}
                            title="Impresora"
                            icon={Prints}
                        />
                    )}
                    {canViewLoans && (
                        <SidebarLink 
                            href="/admin/loans" 
                            currentPath={currentPath}
                            title="Préstamo"
                            icon={Archive}
                        />
                    )}
                    {canViewLockers && (
                        <SidebarLink 
                            href="/admin/lockers" 
                            currentPath={currentPath}
                            title="Taquillas"
                            icon={Lock}
                        />
                    )}
                    {canViewInventory && (
                        <SidebarLink 
                            href="/admin/inventory" 
                            currentPath={currentPath}
                            title="Inventario"
                            icon={Almacen}
                        />
                    )}
                </>
            )}

            <!-- Sección Gestión -->
            {gestionSectionVisible && (
                <>
                    <div class="text-white/50 text-xs font-semibold uppercase tracking-wider mb-3 mt-6">
                        Gestión
                    </div>
                    {canViewInventoryCoord && (
                        <SidebarLink 
                            href="/admin/warehouse" 
                            currentPath={currentPath}
                            title="Inventario"
                            icon={Almacen}
                        />
                    )}
                    {canViewUsers && (
                        <SidebarLink 
                            href="/admin/users" 
                            currentPath={currentPath}
                            title="Usuarios"
                            icon={Users}
                        />
                    )}

                    {/*canViewRoles && (
                        <SidebarLink 
                            href="/admin/roles" 
                            currentPath={currentPath}
                            title="Roles"
                            icon={Tags}
                        />
                    )*/}

                    {canViewEvents && (
                        <SidebarLink 
                            href="/admin/events" 
                            currentPath={currentPath}
                            title="Eventos"
                            icon={CalendarConfig}
                        />
                    )}
                </>
            )}

            <!-- Sección Sistema -->
            {sistemaSectionVisible && (
                <>
                    <div class="text-white/50 text-xs font-semibold uppercase tracking-wider mb-3 mt-6">
                        Sistema
                    </div>

                    {canViewSettings && (
                        <SidebarLink 
                            href="/admin/settings" 
                            currentPath={currentPath}
                            title="Configuración"
                            icon={Settings}
                        />
                    )}

                    {canViewLogs && (
                        <SidebarLink 
                            href="/admin/logs" 
                            currentPath={currentPath}
                            title="Logs del Sistema"
                            icon={History}
                        />
                    )}
                </>
            )}

            <!-- Separador -->
            <div class="border-t border-white/10 my-4"></div>

            <!-- Volver al sitio -->
            <a 
                href="/" 
                class="admin-nav-link group flex items-center px-3 py-2.5 rounded-lg transition-all duration-200 text-white/60 hover:bg-white/5 hover:text-white/80"
            >
                <div class="w-5 h-5 mr-3 flex-shrink-0"> <ArrowBack/>
                </div>
                <span>Volver al sitio</span>
            </a>
        </nav>
    </div>
</aside>

<style>
    .admin-nav-link {
        position: relative;
        overflow: hidden;
    }
    
    .admin-nav-link::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        height: 0;
        width: 3px;
        background: var(--color-dai);
        transform: translateY(-50%);
        transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .admin-nav-link:hover::before {
        height: 100%;
    }

    /* Scrollbar personalizado para el sidebar */
    aside::-webkit-scrollbar {
        width: 4px;
    }
    
    aside::-webkit-scrollbar-track {
        background: transparent;
    }
    
    aside::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
    }
    
    aside::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Estilos adicionales para móvil */
    @media (max-width: 1024px) {
        aside {
            /* Asegurar que el sidebar ocupe toda la altura en móvil */
            height: calc(100vh - 3.5rem);
        }
    }
</style>

<script>
    // Funcionalidad para mostrar/ocultar sidebar en móvil
    function initializeAdminSidebar() {
        const sidebar = document.querySelector('[data-sidebar]');
        const overlay = document.querySelector('[data-sidebar-overlay]');
        const toggleButton = document.querySelector('[data-sidebar-toggle]');
        const closeButton = document.querySelector('[data-sidebar-close]');

        // Si no existen los elementos, no hacer nada (no estamos en una página de admin)
        if (!sidebar || !overlay || !toggleButton || !closeButton) {
            return;
        }

        function showSidebar() {
            // Cerrar navbar móvil si está abierta
            const navMenuButton = document.getElementById('menu-button');
            const navMobileMenu = document.getElementById('mobile-menu-panel');
            if (navMenuButton && navMenuButton.classList.contains('is-active')) {
                navMenuButton.classList.remove('is-active');
                navMenuButton.setAttribute('aria-expanded', 'false');
                navMenuButton.setAttribute('aria-label', 'Abrir menú');
                if (navMobileMenu) {
                    navMobileMenu.setAttribute('aria-hidden', 'true');
                    navMobileMenu.classList.add('translate-x-full');
                    navMobileMenu.classList.add('opacity-0');
                }
            }

            if (sidebar) sidebar.classList.remove('-translate-x-full');
            if (overlay) overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
        }

        function hideSidebar() {
            if (sidebar) sidebar.classList.add('-translate-x-full');
            if (overlay) overlay.classList.add('hidden');
            
            // Solo restaurar el scroll si la navbar móvil tampoco está abierta
            const navMenuButton = document.getElementById('menu-button');
            if (!navMenuButton || !navMenuButton.classList.contains('is-active')) {
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
            }
        }

        // Toggle sidebar cuando se hace click en el botón hamburguesa
        toggleButton.addEventListener('click', (e) => {
            e.preventDefault();
            showSidebar();
        });

        // Cerrar sidebar cuando se hace click en el overlay
        overlay.addEventListener('click', hideSidebar);

        // Cerrar sidebar cuando se hace click en el botón de cerrar
        closeButton.addEventListener('click', (e) => {
            e.preventDefault();
            hideSidebar();
        });

        // Cerrar sidebar cuando se hace click en un enlace (solo en móvil)
        const sidebarLinks = document.querySelectorAll('aside a[href]');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 1024) {
                    setTimeout(hideSidebar, 150);
                }
            });
        });

        // Cerrar sidebar cuando se presiona Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideSidebar();
            }
        });

        // Cerrar sidebar automáticamente cuando la pantalla se hace más grande
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                hideSidebar();
            }
        });
    }

    // Reinicializar la sidebar después de las transiciones de página
    function reinitializeAdminSidebar() {
        // Pequeño delay para asegurar que el DOM esté completamente cargado
        setTimeout(initializeAdminSidebar, 50);
    }

    // Inicializar al cargar la página por primera vez
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeAdminSidebar);
    } else {
        initializeAdminSidebar();
    }

    // Reinicializar después de cada navegación entre páginas
    document.addEventListener('astro:page-load', reinitializeAdminSidebar);
    document.addEventListener('astro:after-swap', reinitializeAdminSidebar);
</script>
