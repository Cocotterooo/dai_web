---
import { supabase } from "@/lib/supabase";

import printStats from "@/components/admin/printStats.astro";
import PrintStats from "@/components/admin/printStats.astro";

// Server Island: todo el procesamiento se hace en el servidor
interface User {
    user_id: string;
    name: string | null;
    full_name: string | null;
    email: string;
    dni: string | null;
    phone: string | null;
    avatar_url: string | null;
    linkedin: string | null;
    tiktok: string | null;
    x: string | null;
    instagram: string | null;
    group_id: string | null;
    group_year: string | null;
    group_branch: string | null;
    group_site: string | null;
    degree_name: string | null;
    roles: {
        role_name: string | null;
        role_id: string | null;
        role_group: string | null;
        role_assigned_at: string | null;
    }[],
    register_date: string
}

interface Stats {
    totalUsers: number;
    newUsersLast30Days: number;
    cdUsers: number;
    xaUsers: number;
}

let users: User[] = [];
let stats: Stats = { totalUsers: 0, newUsersLast30Days: 0, cdUsers: 0, xaUsers: 0 };
let error = '';

let allRoleNames: string[] = [];
let allRoleIds: string[] = [];
let groupsData: any[] = [];

try {
    // Verificar autenticaci√≥n y permisos
    const user = Astro.locals.user;
    const userRoleIds = (Astro.locals.userRoleIds as unknown as string[]) || [];
    
    if (!user) {
        throw new Error("No autorizado");
    }

    const hasPermission = userRoleIds.includes("admin") 
                        || userRoleIds.includes("dai_delegate") 
                        || userRoleIds.includes("dai_secretary")
                        || userRoleIds.includes("dai_free_member");

    if (!hasPermission) {
        throw new Error("Permisos insuficientes");
    } 

    console.log("‚úÖ Cargando usuarios desde Server Island");
    
    // Obtener todos los roles existentes
    const { data: rolesData, error: rolesError } = await supabase
        .rpc("get_all_roles");
    allRoleNames = rolesData.map((role: { name: string }) => role.name);
    allRoleIds = rolesData.map((role: { id: string }) => role.id);

    if (rolesError) {
        console.error("‚ùå Error cargando roles:", rolesError);
        throw rolesError;
    }
    //console.log("‚úÖ Roles cargados:", rolesData);

    // Obtener todos los grupos XA con informaci√≥n de delegados
    console.log("üè´ Intentando cargar grupos XA...");
    try {
        const { data: groupsXAData, error: groupsError } = await supabase
            .rpc("get_all_groups_xa");

        if (groupsError) {
            console.error("‚ùå Error espec√≠fico cargando grupos:", groupsError);
            console.log("‚ö†Ô∏è Continuando sin datos de grupos...");
            groupsData = [];
        } else {
            groupsData = groupsXAData || [];
        }
    } catch (groupsException) {
        console.error("‚ùå Excepci√≥n cargando grupos:", groupsException);
        console.log("‚ö†Ô∏è La funci√≥n get_all_groups_xa puede no existir. Continuando sin grupos...");
        groupsData = [];
    }

    // Obtener usuarios con roles
    const { data: usersData, error: usersError } = await supabase
        .rpc("get_users_with_all_info");

    if (usersError) {
        console.error("‚ùå Error cargando usuarios:", usersError);
        throw usersError;
    }
    const rawUsers = (usersData || []) as User[];
    console.log(`üìä Filas recibidas de la base de datos: ${rawUsers.length}`);
;
    // Ordenar por fecha de creaci√≥n (m√°s recientes primero)
    users = Array.from(rawUsers.values()).sort((a, b) => 
        new Date(b.register_date || '').getTime() - new Date(a.register_date || '').getTime()
    );

    console.log(`üë• Usuarios procesados: ${users.length}`);

    // Calcular estad√≠sticas
    stats.totalUsers = users.length;
    
    // Usuarios nuevos √∫ltimos 30 d√≠as
    const currentDate = new Date();
    const last30Days = new Date(currentDate.setDate(currentDate.getDate() - 30));
    const newUsersLast30Days = users.filter((user) => {
        return user.register_date && new Date(user.register_date) >= last30Days;
    });
    const numberNewUsers = newUsersLast30Days.length;
    stats.newUsersLast30Days = numberNewUsers;

    // Contar miembros DAI (usuarios perdenecientes a la CD)
    stats.cdUsers = users.filter((user) => {
        return user.roles && user.roles.some((role) => role.role_group === 'CD');
    }).length;

    // Contar miembros XA (usuarios pertenecientes a la XA)
    stats.xaUsers = users.filter((user) => {
        return user.roles && user.roles.some((role) => role.role_group === 'XA');
    }).length;

    console.log("üìà Estad√≠sticas calculadas:", stats);

} catch (err) {
    console.error("‚ùå Error en UsersServerIsland:", err);
    error = err instanceof Error ? err.message : 'Error desconocido';
}

// Obtener todos los roles √∫nicos para los filtros
const allRoles = new Set<string>();
const allRoleGroups = new Set<string>();
const allDegrees = new Set<string>();
const allGroups = new Set<string>();


users.forEach(user => {
    if (user.roles && Array.isArray(user.roles)) {
        user.roles.forEach(role => {
            if (role.role_name) {
                allRoles.add(role.role_name);
            }
            if (role.role_group) {
                allRoleGroups.add(role.role_group);
            }
        });
        if (user.degree_name) {
            allDegrees.add(user.degree_name);
        }
    }
    
    const groupName = user.group_id
    if (groupName && typeof groupName === 'string') {
        allGroups.add(groupName);
    }
});

console.log(`üè∑Ô∏è Roles √∫nicos encontrados: ${allRoles.size}, Grupos √∫nicos: ${allGroups.size}`);
---

<!-- Server Island: contenido renderizado en el servidor -->
<div id="users-server-island" 
    data-users={JSON.stringify(users)} 
    data-stats={JSON.stringify(stats)} 
    data-roles={JSON.stringify(Array.from(allRoles).sort())} 
    data-role-groups={JSON.stringify(Array.from(allRoleGroups).sort())}
    data-degrees={JSON.stringify(Array.from(allDegrees).sort())}
    data-groups={JSON.stringify(Array.from(allGroups).sort())} 
    data-groups-xa={JSON.stringify(groupsData || [])}
    data-error={error}
    data-role-names={JSON.stringify(allRoleNames)}
    data-role-ids={JSON.stringify(allRoleIds)}>
    {error ? (
        <div class="text-center text-red-400 py-8">
            <h3 class="text-lg font-semibold mb-2">Error al cargar usuarios</h3>
            <p>{error}</p>
        </div>
    ) : (
        <>
            <!-- Estad√≠sticas -->
            <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8">
                <PrintStats stats={stats} title="Impresiones (Hoy)" description="Campus / Ciudad" stat1={stats.newUsersLast30Days} stat2={stats.totalUsers} stat3={String(stats.totalUsers + stats.totalUsers)} textColor="text-dai"/>
                <PrintStats stats={stats} title="Impresiones (√öltimos 30 D√≠as)" description="Campus / Ciudad" stat1={stats.newUsersLast30Days} stat2={stats.totalUsers} stat3={String(stats.totalUsers + stats.totalUsers)} textColor="text-dai"/>
                <PrintStats stats={stats} title="Impresiones (Inicio de Curso)" description="Campus / Ciudad" stat1={stats.cdUsers} stat2={stats.totalUsers} stat3={String(stats.totalUsers + stats.totalUsers)} textColor="text-purple-400"/>
                <PrintStats stats={stats} title="Impresiones (Totales)" description="Campus / Ciudad" stat1={stats.xaUsers} stat2={stats.totalUsers} stat3={String(stats.totalUsers + stats.totalUsers)} textColor="text-purple-400"/>
            </div>

            <!-- Gesti√≥n de Impresiones -->
            <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl p-3 sm:p-4 lg:p-6">
                <div class="flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl font-semibold text-white">Gestor de Impresiones</h2>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                        <button 
                            id="refresh-prints-btn"
                            class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-dai hover:bg-dai/80 text-white rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 text-sm"
                            onclick="window.location.reload()"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Actualizar
                        </button>
                    </div>
                </div>
                
                <!-- Panel principal de gesti√≥n de impresiones -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Panel izquierdo: Datos del usuario seleccionado -->
                    <div class="bg-azul-oscuro/50 border border-white/20 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Usuario Seleccionado
                        </h3>
                        
                        <div id="selected-user-info" class="space-y-4">
                            <!-- Estado por defecto sin usuario seleccionado -->
                            <div id="no-user-selected" class="text-center py-8">
                                <div class="w-20 h-20 bg-white/10 rounded-full mx-auto mb-4 flex items-center justify-center">
                                    <svg class="w-10 h-10 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <p class="text-white/60 text-sm">Selecciona un usuario para ver sus datos</p>
                            </div>
                            
                            <!-- Informaci√≥n del usuario cuando est√© seleccionado -->
                            <div id="user-selected-info" class="hidden">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div id="user-avatar" class="w-16 h-16 bg-dai/20 rounded-full flex items-center justify-center border-2 border-dai/30">
                                        <span id="user-initial" class="text-dai font-semibold text-xl"></span>
                                    </div>
                                    <div class="flex-1">
                                        <h4 id="user-name" class="text-white font-semibold text-lg"></h4>
                                        <p id="user-email" class="text-white/60 text-sm"></p>
                                        <p id="user-dni" class="text-white/60 text-xs"></p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-white/5 rounded-lg p-3 text-center">
                                        <div id="user-remaining-prints" class="text-2xl font-bold text-dai mb-1">--</div>
                                        <div class="text-white/60 text-xs">Impresiones restantes</div>
                                    </div>
                                    <div class="bg-white/5 rounded-lg p-3 text-center">
                                        <div id="user-total-prints" class="text-2xl font-bold text-purple-400 mb-1">--</div>
                                        <div class="text-white/60 text-xs">Total realizadas</div>
                                    </div>
                                </div>
                                
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-white/60">Grupo:</span>
                                        <span id="user-group" class="text-white">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-white/60">Grado:</span>
                                        <span id="user-degree" class="text-white">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-white/60">Tel√©fono:</span>
                                        <span id="user-phone" class="text-white">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel derecho: B√∫squeda y datos de impresi√≥n -->
                    <div class="space-y-4">
                        <!-- B√∫squeda de usuario -->
                        <div class="bg-azul-oscuro/50 border border-white/20 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Buscar Usuario
                            </h3>
                            
                            <div class="space-y-3">
                                <input 
                                    type="text" 
                                    id="user-search-input"
                                    placeholder="DNI/NIE o n√∫mero de tel√©fono..."
                                    class="w-full px-3 py-2 bg-azul-oscuro border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-dai text-sm"
                                />
                                <button 
                                    id="search-user-btn"
                                    class="w-full px-4 py-2 bg-dai hover:bg-dai/80 text-white rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 text-sm"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    Buscar Usuario
                                </button>
                                
                                <!-- Resultados de b√∫squeda -->
                                <div id="search-results" class="hidden space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Los resultados se cargar√°n din√°micamente aqu√≠ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Datos de la impresi√≥n -->
                        <div class="bg-azul-oscuro/50 border border-white/20 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                Datos de Impresi√≥n
                            </h3>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-white/60 text-sm mb-2">N√∫mero de p√°ginas</label>
                                    <input 
                                        type="number" 
                                        id="pages-input"
                                        min="1"
                                        placeholder="Ej: 5"
                                        class="w-full px-3 py-2 bg-azul-oscuro border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-dai text-sm"
                                    />
                                </div>
                                
                                <div>
                                    <label class="block text-white/60 text-sm mb-2">N√∫mero de hojas</label>
                                    <input 
                                        type="number" 
                                        id="sheets-input"
                                        min="1"
                                        placeholder="Se calcula autom√°ticamente"
                                        class="w-full px-3 py-2 bg-azul-oscuro border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-dai text-sm"
                                    />
                                    <p class="text-white/40 text-xs mt-1">Editable para impresi√≥n a una cara</p>
                                </div>
                                
                                <div>
                                    <label class="block text-white/60 text-sm mb-2">Tipo de impresi√≥n</label>
                                    <select 
                                        id="print-type-select"
                                        class="w-full px-3 py-2 bg-azul-oscuro border border-white/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-dai text-sm"
                                    >
                                        <option value="bw">Blanco y Negro</option>
                                        <option value="color">Color</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-white/60 text-sm mb-2">Miembro CD responsable</label>
                                    <select 
                                        id="cd-member-select"
                                        class="w-full px-3 py-2 bg-azul-oscuro border border-white/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-dai text-sm"
                                    >
                                        <option value="">Seleccionar miembro...</option>
                                        <!-- Se cargar√°n din√°micamente los miembros de la CD -->
                                    </select>
                                </div>
                            </div>
                            
                            <button 
                                id="register-print-btn"
                                disabled
                                class="w-full mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 text-sm"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Registrar Impresi√≥n
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n de emails de la API -->
                <div class="bg-azul-oscuro/50 border border-white/20 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Emails de Impresi√≥n
                        </h3>
                        <button 
                            id="refresh-emails-btn"
                            class="px-3 py-1 bg-dai/20 hover:bg-dai/40 text-white rounded text-xs transition-colors duration-200"
                        >
                            Actualizar
                        </button>
                    </div>
                    
                    <div id="emails-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Estado inicial -->
                        <div class="text-center py-6 text-white/60">
                            <svg class="w-8 h-8 mx-auto mb-2 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-sm">Cargar emails de la API</p>
                            <button 
                                id="load-emails-btn"
                                class="mt-2 px-4 py-2 bg-dai hover:bg-dai/80 text-white rounded-lg text-xs transition-colors duration-200"
                            >
                                Cargar Emails
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </>
    )}
</div>

<style>
/* Mejoras responsive para el gestor */
@media (max-width: 1024px) {
    .lg\\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 640px) {
    .sm\\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    /* Reducir padding en m√≥viles */
    .bg-azul-oscuro\\/50 {
        padding: 0.75rem !important;
    }
}
</style>

<script type="module">

</script>
