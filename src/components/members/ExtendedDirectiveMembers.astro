---
// Server Island para la Directiva Extendida DAI
import { supabase } from "../../lib/supabase";
import MemberCard from "./memberCard.astro";

const roleEmails = {
    'dai_delegate': 'delegado@dai.uvigo.gal',
    'dai_subdelegate': 'subdelegada@dai.uvigo.gal',
    'dai_secretary': 'secretario@dai.uvigo.gal',
    'dai_treasurer': 'tesouraria@dai.uvigo.gal',
    'dai_communication_coord': 'redes@dai.uvigo.gal',
    'dai_infrastructure_coord': 'infraestructuras@dai.uvigo.gal',
    'dai_foreign_affairs_coord': 'externas@dai.uvigo.gal',
    'dai_leisure_sports_coord': 'deporteseocio@dai.uvigo.gal',
    'local_ceeibis_representative': 'uvigo@ceeibis.com',
};

type Member = {
    id: string;
    name: string;
    avatar_url: string;
    role_id: keyof typeof roleEmails;
    role_name: string;
    email?: string;
    x?: string;
    linkedin?: string;
    tiktok?: string;
    instagram?: string;
};

let sortedExtendedMembers: Member[] = [];
let error = null;

try {
    const { data: extended_members_data, error: dbError } = await supabase
        .from('dai_directiva_extendida_users')
        .select('*');
    
    if (dbError) throw dbError;
    
    const extended_members: Member[] = extended_members_data || [];
    const roleExtendedOrder = [
        'dai_communication_coord', 
        'dai_infrastructure_coord', 
        'dai_foreign_affairs_coord', 
        'dai_leisure_sports_coord', 
        'local_ceeibis_representative',
    ];

    // Ordenar los miembros de la directiva extendida según el orden especificado
    sortedExtendedMembers = extended_members.sort((a, b) => {
        const orderA = roleExtendedOrder.indexOf(a.role_id);
        const orderB = roleExtendedOrder.indexOf(b.role_id);
        
        // Si el rol no está en la lista, ponerlo al final
        if (orderA === -1 && orderB === -1) return 0;
        if (orderA === -1) return 1;
        if (orderB === -1) return -1;
        
        return orderA - orderB;
    });
} catch (e) {
    error = e;
}
---

{error && (
    <div class="text-center text-red-400 p-4">
        <p>Error al cargar los miembros de la directiva extendida</p>
        <p class="text-sm text-white/60">Intenta recargar la página</p>
    </div>
)}

{!error && (
    <div class="flex flex-row flex-wrap justify-center gap-2">
        {sortedExtendedMembers.map(member => (
            <MemberCard 
                key={member.id} 
                name={member.name} 
                avatarUrl={member.avatar_url} 
                role={member.role_name.endsWith(' - DAI') ? member.role_name.slice(0, -6) : member.role_name}
                email={roleEmails[member.role_id as keyof typeof roleEmails]} 
                x={member.x} 
                linkedin={member.linkedin} 
                tiktok={member.tiktok} 
                instagram={member.instagram} 
            />
        ))}
    </div>
)}
