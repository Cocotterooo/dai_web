---
// Componente para mostrar estadísticas de impresión
import { supabase } from "@/lib/supabase";

interface Props {
    thisMonthSheets: number;
    thisMonthPages: number;
    limitSheets: number;
    limitPages: number;
    totalSheets: number;
    totalPages: number;
    limit: number;
    percentageSheets: number;
}

// ID del usuario actual (para futuras mejoras)
const userId = Astro.locals.user?.id as string;
const user = Astro.locals.user;

// Verificar si el perfil está completo
const hasPhone = user?.user_metadata?.phone;
const hasDni = user?.user_metadata?.dni;
const hasFullName = user?.user_metadata?.full_name;
const isProfileComplete = hasPhone && hasDni && hasFullName;

async function getPrintingStats(userId: string) {
    const { data, error } = await supabase
        .rpc('get_printing_stats', { user_uuid: userId })

    if (error) {
        console.error('Error al obtener estadísticas:', error)
        return null
    }

    return data[0]
}

// Solo obtener estadísticas si el perfil está completo
let stats = null;
if (isProfileComplete) {
    stats = await getPrintingStats(userId);
}

let calcPercentage = 0;
const thisMonthSheet = stats?.sheets_last_month || 0;
const limitSheet = 20; // Límite mensual de hojas (puede ser dinámico)
const limitPage = 40; // Límite mensual de páginas (puede ser dinámico)

// Calcular el porcentaje de uso del límite de hojas
const percentage = (thisMonthSheet * 100) / limitSheet || 0;
if (percentage >= 100) {
    calcPercentage = 100;
} else if (percentage <= 0) {
    calcPercentage = 0;
} else {
    calcPercentage = percentage;
}
console.log(stats)
const { 
    thisMonthSheets = thisMonthSheet,
    thisMonthPages = stats?.pages_last_month || 0,
    totalSheets = stats?.sheets_total || 0,
    totalPages = stats?.pages_total || 0, 
    limitSheets = limitSheet,
    limitPages = limitPage,
    percentageSheets = calcPercentage,
} = Astro.props;

// Función para determinar el color de la barra del límite de hojas
function getProgressBarColor(percentage: number): string {
    if (percentage >= 100) {
        return '#ef4444'; // Rojo - límite alcanzado o superado
    } else if (percentage >= 25) {
        return '#f97316'; // Naranja - 25% o menos restante
    } else if (percentage >= 50) {
        return '#eab308'; // Amarillo - más de la mitad del límite
    } else {
        return '#06b6d4'; // Azul brillante (color original) - menos de la mitad
    }
}
---

<div class="bg-white/5 border border-white/20 rounded-xl p-3 sm:p-4 flex flex-col justify-between h-full min-h-[150px]">
    {isProfileComplete ? (
        <>
            <div>
                <h3 class="font-semibold text-lg text-white mb-2">Impresiones</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-300 text-sm">Hojas este mes:</span>
                        <span class="text-azul-brillante font-bold">{thisMonthSheets} /{limitSheets}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300 text-sm">Páginas este mes:</span>
                        <span class="text-azul-brillante font-bold">{thisMonthPages} /{limitPages}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300 text-sm">Total histórico (p-h):</span>
                        <span class="text-white font-bold">{totalPages} - {totalSheets}</span>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <div class="w-full bg-white/10 rounded-full h-2">
                    <div class="h-2 rounded-full animate-pulse-slow" style={`width: ${percentageSheets}%; background-color: ${getProgressBarColor(percentageSheets)}`}></div>
                </div>
                <p class="text-xs text-gray-400 mt-1">Límite mensual (hojas): {limitSheets}</p>
            </div>
        </>
    ) : (
        <div class="flex flex-col items-center justify-center h-full text-center">
            <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
            </div>
            <h3 class="font-semibold text-lg text-white mb-2">Perfil Incompleto</h3>
            <p class="text-gray-300 text-sm mb-4 leading-relaxed">
                Completa tu perfil para ver tus estadísticas de impresión
            </p>
            <a 
                href="/complete-profile"
                class="inline-flex text-center items-center bg-dai/20 border border-dai/30 text-white py-2 px-4 rounded-lg font-medium hover:bg-dai/50 hover:border-dai focus:outline-none focus:ring-1 focus:ring-dai focus:ring-offset-1 focus:ring-offset-transparent transition-all duration-300 backdrop-blur-sm"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Completar Perfil
            </a>
        </div>
    )}
</div>

<style>
    .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
        50% {
            opacity: 0.7;
        }
    }
</style>