---
// Wrapper para UserCard que maneja errores de manera segura
import UserCard from "./user-card.astro";
import UserCardSkeleton from "../ui/skeletons/UserCardSkeleton.astro";

const user = Astro.props.user;
let hasError = false;
let errorMessage = '';

// Verificar que tenemos los datos mínimos necesarios
if (!user) {
    hasError = true;
    errorMessage = 'Usuario no disponible';
}
---

<div class="col-span-10 md:col-span-6 lg:col-span-4 xl:col-span-3 overflow-hidden flex flex-col">
{hasError ? (
    <div>
        <UserCardSkeleton />
        <script define:vars={{ errorMessage }}>
            console.warn('UserCard: Mostrando skeleton debido a:', errorMessage);
        </script>
    </div>
) : (
    <div class="user-card-wrapper">
        <UserCard user={user} />
        <script>
            // Manejo de errores del lado del cliente
            document.addEventListener('DOMContentLoaded', () => {
                const wrapper = document.querySelector('.user-card-wrapper');
                if (wrapper) {
                    // Verificar si el componente se renderizó correctamente
                    const content = wrapper.innerHTML.trim();
                    if (!content || content.includes('error') || content.includes('failed')) {
                        console.warn('UserCard: Detectado problema en renderizado, cargando contenido dinámicamente');
                        
                        // Cargar datos de forma asíncrona
                        fetch('/api/profile/user-info')
                            .then(response => response.json())
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                // Actualizar contenido si es necesario
                            })
                            .catch(error => {
                                console.error('Error cargando datos del usuario:', error);
                                // Mantener skeleton visible
                            });
                    }
                }
            });
        </script>
    </div>
)}
</div>

<template data-fallback>
    <UserCardSkeleton />
</template>
