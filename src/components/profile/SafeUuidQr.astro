---
// Wrapper para UuidQr que maneja errores de manera segura
import UuidQr from "./uuid-qr.astro";
import UuidQrSkeleton from "../ui/skeletons/UuidQrSkeleton.astro";

const user = Astro.locals?.user;
let hasError = false;
let errorMessage = '';

// El QR necesita un usuario válido
try {
    if (!user?.id) {
        hasError = true;
        errorMessage = 'No se puede generar QR sin ID de usuario';
    }
} catch (error) {
    hasError = true;
    errorMessage = `Error preparando QR: ${error}`;
}
---

<div class="col-span-10 md:col-span-4 lg:col-span-2 xl:col-span-3">
{hasError ? (
    <div>
        <UuidQrSkeleton />
        <script define:vars={{ errorMessage }}>
            console.warn('UuidQr: Mostrando skeleton debido a:', errorMessage);
        </script>
    </div>
) : (
    <div class="uuid-qr-wrapper">
        <UuidQr />
        <script>
            // Manejo de errores del lado del cliente para QR
            document.addEventListener('DOMContentLoaded', () => {
                const wrapper = document.querySelector('.uuid-qr-wrapper');
                if (wrapper) {
                    // Verificar si el componente se renderizó correctamente
                    const content = wrapper.innerHTML.trim();
                    if (!content || content.includes('error') || content.includes('failed')) {
                        console.warn('UuidQr: Detectado problema en renderizado');
                        
                        // Intentar cargar QR de forma asíncrona
                        fetch('/api/profile/generate-qr')
                            .then(response => response.json())
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                // Actualizar QR si es necesario
                            })
                            .catch(error => {
                                console.error('Error generando QR:', error);
                                // Mantener skeleton visible
                            });
                    }
                }
            });
        </script>
    </div>
)}
</div>

<template data-fallback>
    <UuidQrSkeleton />
</template>
